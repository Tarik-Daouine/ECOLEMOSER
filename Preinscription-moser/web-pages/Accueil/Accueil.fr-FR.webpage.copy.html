<!-- Accueil.html – Pré-inscription Ecole Moser
     Routage fiable des étapes, avec décision dynamique pour Parent 2 (Edit vs Create)
-->

{% assign accountId = user.parentcustomerid.id %} {% assign parent1Email = user.email %} {% assign parent1Id = user.id %}

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Pré-inscription</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      #route-loader{display:flex;align-items:center;justify-content:center;min-height:40vh;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
      .hidden{display:none}
    </style>
    <script>
      // Contexte minimal injecté côté serveur (Liquid)
      window.__ctx = {
        // On initialise sans dépendre de Liquid pour le compte famille
        accountId: {{ accountId | jsonify }},
        parent1Email: {{ parent1Email | jsonify }},
        parent1Id: {{ parent1Id | jsonify }},

        // Id du contact connecté (utilisé pour récupérer le compte en Web API)
        userId: {{ parent1Id | jsonify }},

        // GUID réels d'étapes du Web Form "Préinscription"
        stepEleve: "cc6337d2-d532-49eb-980f-8a7f99b64cc8",
        stepParent1: "ccbc4cf6-7ca7-4937-beb7-82f055a41e84",
        stepP2Edit: "f0772474-e04d-f011-877a-000d3a2f84b0",
        stepP2Create: "c915c1c0-437c-f011-b4cc-000d3a2f84b0",

        // Valeur entière de l’optionset "Parent" dans contact.new_typedecontact
        parentTypeValue: 100000001
      };
      console.log('[Pré-inscription] Liquid values →', {
        accountId: {{ accountId | jsonify }},
        parent1Email: {{ parent1Email | jsonify }},
        parent1Id: {{ parent1Id | jsonify }}
      });
    </script>
  </head>
  <body>
    <noscript>Active JavaScript pour poursuivre la pré-inscription.</noscript>
    <div id="route-loader">Préparation du formulaire…</div>

    <script>
      (async function(){
        const ctx = window.__ctx || {};
        const log = (...a)=>console.log("[Pré-inscription]", ...a);
        const err  = (...a)=>console.error("[Pré-inscription]", ...a);

        // 0) Récupérer dynamiquement accountId + email du parent connecté via Web API (fiable)
        try {
          if(ctx.userId && !ctx.accountId){
            const urlMe = `/_api/contacts(${ctx.userId})?$select=_parentcustomerid_value,emailaddress1`;
            const rm = await fetch(urlMe, { headers: { "Accept":"application/json" }});
            if(rm.ok){
              const jm = await rm.json();
              ctx.accountId = jm["_parentcustomerid_value"] || null;
              ctx.parent1Email = jm["emailaddress1"] || null;
            }
          }
        } catch(e){ err("Lookup compte famille:", e); }

        if(!ctx.accountId){
          err("Compte Famille manquant pour l'utilisateur connecté.");
        }

        const cur = new URL(location.href);
        const qp  = cur.searchParams;
        const setAndGo = (paramsObj)=>{
          const p = new URLSearchParams(paramsObj);
          const target = location.pathname + "?" + p.toString();
          if (location.search !== "?" + p.toString()){
            location.replace(target);
          } else {
            document.getElementById("route-loader")?.classList.add("hidden");
            document.getElementById("webform-shell")?.classList.remove("hidden");
          }
        };

        // 1) Si aucune step n’est fournie, on commence par Élève
        if(!qp.get("stepid") && ctx.stepEleve){
          setAndGo({ stepid: ctx.stepEleve });
          return;
        }

        // 2) Déjà en P2 ? → ne pas rerouter
        const stepid = (qp.get("stepid") || "").toUpperCase();
        if (stepid === (ctx.stepP2Edit||"").toUpperCase() || stepid === (ctx.stepP2Create||"").toUpperCase()){
          document.getElementById("route-loader")?.classList.add("hidden");
          document.getElementById("webform-shell")?.classList.remove("hidden");
          return;
        }

        // 3) Si on n'est pas sur Parent1, on laisse afficher
        if (stepid && stepid !== (ctx.stepParent1||"").toUpperCase()){
          document.getElementById("route-loader")?.classList.add("hidden");
          document.getElementById("webform-shell")?.classList.remove("hidden");
          return;
        }

        // 4) Décision Parent2 (Edit vs Create) — construire l'URL sans retours à la ligne pour éviter les SyntaxError
        try {
          const email1 = (ctx.parent1Email || "").replace(/'/g,"''");
          const filter = `new_typedecontact eq ${ctx.parentTypeValue} and _parentcustomerid_value eq ${ctx.accountId}` + (email1 ? ` and emailaddress1 ne '${email1}'` : "");
          const url = "/_api/contacts?$select=contactid&$top=1&$filter=" + encodeURIComponent(filter);

          const r = await fetch(url, { headers: { "Accept":"application/json" }});
          if(!r.ok){ throw new Error("HTTP " + r.status); }
          const data = await r.json();
          const hasP2 = Array.isArray(data.value) && data.value.length > 0;
          const p2Id  = hasP2 ? data.value[0].contactid : null;

          if(hasP2){
            setAndGo({ stepid: ctx.stepP2Edit, parent2id: p2Id });
          } else {
            setAndGo({ stepid: ctx.stepP2Create, accountid: ctx.accountId });
          }
        } catch(e){
          err("Décision Parent2 :", e);
          document.getElementById("route-loader")?.classList.add("hidden");
          document.getElementById("webform-shell")?.classList.remove("hidden");
        }
      })();
    </script>

    <div id="webform-shell" class="hidden">{% if request.params.stepid %} {% webform name:'Préinscription' %} {% endif %}</div>
  </body>
</html>
<div class="row sectionBlockLayout text-start" style="display: flex; flex-wrap: wrap; margin: 0px; min-height: auto; padding: 8px;">
  <div class="container" style="padding: 0px; display: flex; flex-wrap: wrap;"><div class="col-lg-12 columnBlockLayout" style="flex-grow: 1; display: flex; flex-direction: column; min-width: 250px;"></div></div>
</div>
